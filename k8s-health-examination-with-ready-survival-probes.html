<!DOCTYPE HTML>
<html lang="zh-CN,en,default">

<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="王柏元的博客">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://baiyuan.wang">
    <!--SEO-->

<meta name="keywords" content="分布式系统,微服务,架构" />


<meta name="description" content="健康检查健康检查（Health Check）可用于服务运行的状态监控，比如腾讯旗下的DNSPOD的D监控，要求配置一个访问路径以判断网站是否可以正常访问实际上就是一个健康检查，当发现健康检查失败..." />


<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->

<title>
    
    K8S使用就绪和存活探针配置健康检查 |
    
    王柏元的博客 | 博学广问，自律静思
</title>

<link rel="alternate" href="/atom.xml" title="王柏元的博客" type="application/atom+xml">


<link rel="icon" href="/favicon.ico">


    


<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.7.0.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">


<meta name="generator" content="Hexo 6.3.0"></head>

<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
<header class="main-header"  style="background-image:url(
    /img/banner.jpg)"
     >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='Baiyuan Wang'>
            <img src="/img/avatar.jpg?rev=@@hash" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
            <!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
            <h2>
                博学广问，自律静思
            </h2>
            
        </div>
    </div>
</header>

<nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                        <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="https://baiyuan.wang">
                        王柏元的博客</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                        <li role="presentation" class="text-center">
                            <a href="/"><i class="fa fa-home"></i>
                                首页</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/技术/"><i class="fa fa-shield"></i>
                                技术</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/岁月/"><i class="fa fa-heartbeat"></i>
                                岁月</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/极客视点/"><i class="fa fa-slideshare"></i>
                                观点</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/archives/"><i class="fa fa-history"></i>
                                时间轴</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
<section class="content-wrap">
    <div class="container">
        <div class="row">
            <main class="col-md-8 main-content m-post">
                <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="K8S使用就绪和存活探针配置健康检查">
            
            K8S使用就绪和存活探针配置健康检查
            
        </h1>
        <div class="post-meta">
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a class="category-link" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            <a class="tag-none-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" rel="tag">分布式系统</a> <a class="tag-none-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a> <a class="tag-none-link" href="/tags/%E6%9E%B6%E6%9E%84/" rel="tag">架构</a>
            
        </span>
    </span>
    
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">
            2019/01/17</span>
    </span>
    
    
</div>
        
        
    </div>
    
    <div class="post-body post-content">
        <h2 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h2><p>健康检查（Health Check）可用于服务运行的状态监控，比如腾讯旗下的DNSPOD的D监控，要求配置一个访问路径以判断网站是否可以正常访问实际上就是一个健康检查，当发现健康检查失败时会发送一个邮件通知或者短信来告知网站管理员进行维修。</p>
<p><img src="https://baiyuan.wang/wp-content/uploads/2019/01/20190117183007118.jpg" alt="K8S流量转发" title="K8S流量转发"></p>
<p>而在现代一些分布式系统中，用户访问不再是单台主机，而是一个由成百上千台实例组成的<strong>集群</strong>，用户请求通过<strong>负载均衡器</strong>分发到不同的实例，<strong>负载均衡</strong>帮助解决单台服务器的访问压力，同时提高了系统的<strong>高可用性</strong>，而<strong>健康检查</strong>常常作为当前实例是否“可用”的判断标准。即：<strong>当系统发现某台实例健康检查不通过，负载均衡器将不会把流量导向该实例</strong>。 现在的云服务厂商比如AWS一般都为负载均衡配备了健康检查，而<strong>Kubernetes</strong>提供了两种探针来检查容器的状态，Liveliness和Readiness，根据<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/#define-readiness-probes">官方文档</a>，Liveliness探针是为了查看容器是否正在运行，翻译为<strong>存活探针</strong>（livenessProbe），Readiness探针是为了查看容器是否准备好接受HTTP请求，翻译为<strong>就绪探针</strong>（readinessProbe）。 在Kubernetes中，Pod是Kubernetes创建及管理的最小的可部署的计算单元，一个Pod由一个或者多个容器（Docker，rocket等等）组成，这些容器共享内存，网络以及运行容器的方式。 在Kubernetes上下文中<strong>存活探针和就绪探针</strong>被称作<strong>健康检查</strong>。这些容器探针是一些周期性运行的小进程，这些探针返回的结果（成功，失败或者未知）反映了容器在Kubernetes的状态。基于这些结果，Kubernetes会判断如何处理每个容器，以保证弹性，高可用性和更长的正常运行时间。</p>
<h2 id="就绪探针"><a href="#就绪探针" class="headerlink" title="就绪探针"></a>就绪探针</h2><p>就绪探针旨在让Kubernetes知道你的应用<strong>是否准备好为请求提供服务</strong>。Kubernetes只有在就绪探针通过才会把流量转发到Pod。如果就绪探针检测失败，Kubernetes将停止向该容器发送流量，直到它通过。</p>
<h2 id="存活探针"><a href="#存活探针" class="headerlink" title="存活探针"></a>存活探针</h2><p>Liveness探测器是让Kubernetes知道你的<strong>应用是否活着</strong>。如果你的应用还活着，那么Kubernetes就让它继续存在。如果你的应用程序已经死了，Kubernetes将移除Pod并重新启动一个来替换它。</p>
<h2 id="工作过程"><a href="#工作过程" class="headerlink" title="工作过程"></a>工作过程</h2><p>让我们看看两个场景，来看看就绪探针和存活探针怎样帮助我们构建更高可用的的系统。</p>
<h3 id="就绪探针-1"><a href="#就绪探针-1" class="headerlink" title="就绪探针"></a>就绪探针</h3><p>一个应用往往需要一段时间来预热和启动，比如一个后端项目的启动需要连接数据库执行数据库迁移等等，一个Spring项目的启动也需要依赖Java虚拟机。即使该过程已启动，您的服务在启动并运行之前也无法运行。应用在完全就绪之前不应接收流量，但默认情况下，Kubernetes会在容器内的进程启动后立即开始发送流量。通过就绪探针探测，直到应用程序完全启动，然后才允许将流量发送到新副本。</p>
<p><img src="https://baiyuan.wang/wp-content/uploads/2019/01/20190117183008212.jpg" alt="就绪探针的工作过程" title="就绪探针的工作过程"></p>
<p>就绪探针的工作过程</p>
<h3 id="存活探针-1"><a href="#存活探针-1" class="headerlink" title="存活探针"></a>存活探针</h3><p>让我们想象另一种情况，当我们的应用在成功启动以后因为一些原因“宕机”，或者遇到死锁情况，导致它无法响应用户请求。 在默认情况下，Kubernetes会继续向Pod发送请求，通过使用存活探针来检测，当发现服务不能在限定时间内处理请求（请求错误或者超时），就会重新启动有问题的pod。</p>
<p><img src="https://baiyuan.wang/wp-content/uploads/2019/01/20190117183008319.jpg" alt="存活探针的工作过程" title="存活探针的工作过程"></p>
<p>存活探针的工作过程</p>
<h2 id="探针类型"><a href="#探针类型" class="headerlink" title="探针类型"></a>探针类型</h2><p>探针类型是指通过何种方式来进行健康检查，K8S有三种类型的探测：HTTP，Command和TCP。 <strong>HTTP</strong> HTTP探测可能是最常见的探针类型。即使应用不是HTTP服务，也可以创建一个轻量级HTTP服务器来响应探测。比如让Kubernetes通过HTTP访问一个URL，如果返回码在200到300范围内，就将应用程序标记为健康状态，否则它被标记为不健康。 更多关于HTTP探测可参考<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/#define-a-liveness-http-request">这里</a>。 <strong>命令</strong> 对于命令探测，是指Kubernetes在容器内运行命令。如果命令以退出代码0返回，则容器将标记为正常。否则，它被标记为不健康。 更多关于命令探测可参考<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/#define-a-liveness-command">这里</a>。 <strong>TCP</strong> 最后一种类型的探测是TCP探测，Kubernetes尝试在指定端口上建立TCP连接。如果它可以建立连接，容器被认为是健康的; 如果它不能被认为是不健康的。这常用于对<a target="_blank" rel="noopener" href="https://grpc.io/">gRPC</a>或FTP服务的探测。 更多关于TCP探测可参考<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/#define-a-tcp-liveness-probe">这里</a>。</p>
<h3 id="初始探测延迟"><a href="#初始探测延迟" class="headerlink" title="初始探测延迟"></a>初始探测延迟</h3><p>我们可以配置K8S健康检查运行的频率，检查成功或失败的条件，以及响应的超时时间。可参考<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/#configure-probes">有关配置探针的文档</a>。 存活探针探测失败会导致pod重新启动，所以配置初始探测延迟 <strong>initialDelaySeconds</strong>十分重要，要确保在应用准备之后探针才启动。否则，应用将无限重启！ 我建议使用<a target="_blank" rel="noopener" href="https://www.quora.com/What-is-p99-latency">p99</a>启动时间作为initialDelaySeconds，或者取平均启动时间外加一个buffer。同时根据应用程序的启动时间更新这个值。</p>
<h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><p>以下面的一个K8S的配置代码为例，</p>
<p>apiVersion: apps&#x2F;v1beta1<br>kind: Deployment<br>…<br>…<br>        readinessProbe:<br>          httpGet:<br>            path: &#x2F;actuator&#x2F;health<br>            port: 8080<br>          initialDelaySeconds: 120<br>          timeoutSeconds: 10<br>        livenessProbe:<br>          httpGet:<br>            path: &#x2F;actuator&#x2F;health<br>            port: 8080<br>          initialDelaySeconds: 60<br>          timeoutSeconds: 10<br>          periodSeconds: 5</p>
<p> </p>
<ul>
<li>K8S将在Pod开始<strong>启动后120s(initialDelaySeconds)后</strong>利用HTTP访问8080端口的 <strong>&#x2F;actuator&#x2F;health</strong>，如果<strong>超过10s</strong>或者返回码不在200~300内，就绪检查就失败</li>
<li>类似的，在Pod运行过程中，K8S仍然会每隔5s(periodSeconds检测8080端口的 <strong>&#x2F;actuator&#x2F;health</strong></li>
</ul>
<p><strong>参考资料</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/blog/products/gcp/kubernetes-best-practices-setting-up-health-checks-with-readiness-and-liveness-probes">【Kubernetes best practices: Setting up health checks with readiness and liveness probes】</a></li>
<li><a target="_blank" rel="noopener" href="http://dockone.io/article/8367">【Kubernetes存活探针和就绪探针的最佳实践】</a></li>
</ul>

    </div>
    
    <div class="post-footer">
        <div>
            
            转载声明：
            商业转载请联系获得授权 ©<a href="/" target="_blank">王柏元的博客</a>, <b>非商业转载请务必注明: </b></br>
原文出处：
                <a href="https://baiyuan.wang/k8s-health-examination-with-ready-survival-probes.html" target="_blank">王柏元的博客 >> K8S使用就绪和存活探针配置健康检查</a>
            
            
        </div>
        <div>
            
        </div>
    </div>
</article>
<div class="article-nav prev-next-wrap clearfix">
    
    <a href="/zipkin-js-instrumentation-axios.html" class="pre-post btn btn-default" title='【开源】zipkin-js-instrumentation-axios: 集成axios和zipkin'>
        <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
        <span class="hidden-xs">
            【开源】zipkin-js-instrumentation-axios: 集成axios和zipkin</span>
    </a>
    
    
    <a href="/trip-san-francisco.html" class="next-post btn btn-default" title='旧金山之行'>
        <span class="hidden-lg">下一篇</span>
        <span class="hidden-xs">
            旧金山之行</span><i class="fa fa-angle-right fa-fw"></i>
    </a>
    
</div>

<div id="comments">
    
<script src="https://cdn.bootcdn.net/ajax/libs/gitalk/1.7.2/gitalk.min.js"></script>
<link href="https://cdn.bootcdn.net/ajax/libs/gitalk/1.7.2/gitalk.min.css" rel="stylesheet">
<div id="gitalk-container">
    <div class="gt-container detail">
    
</div>

</div>
<script type="text/javascript">
var gitalk = new Gitalk({
    // Gitalk配置
    language: "zh-CN,en,default",
    clientID: "8fbc26599e94fd5e4f2d",
    clientSecret: "16d6dc93d6a850229a9fd96c74096bd5d491eb82",
    repo: "blog",
    owner: "wangbaiyuan",
    admin: ["geekeren"],
    id: "52212",
    distractionFreeMode: "true"
});
gitalk.render('gitalk-container');
</script>


    <div class="gt-container detail">
    
        <div class="gt-comments">
            <div style="position: relative;">
                <div class="gt-comment gt-comment-admin" style="transform-origin: center top;">
                    
                        <div class="gt-avatar gt-comment-avatar">
                            <img src="https://wangbaiyuan.cn/wp-content/avatars/cb48862d82bef57b1c6c4e83e6054f16.png"
                                 alt="@免费SSR节点">
                        </div>
                    

                    <div class="gt-comment-content">
                        <div class="gt-comment-header">
                            <div class="gt-comment-block-2"></div>
                            <a class="gt-comment-username">
                                免费SSR节点
                            </a>
                            
                                <span class="gt-comment-text">commented at</span>
                            
                            <span class="gt-comment-date">
                                2019-02-10
                            </span>
                        </div>
                        <div class="gt-comment-body markdown-body">
                            <p>
                                纯纯地支持一下~
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <div class="gt-comments">
            <div style="position: relative;">
                <div class="gt-comment gt-comment-admin" style="transform-origin: center top;">
                    
                        <div class="gt-avatar gt-comment-avatar">
                            <img src="https://wangbaiyuan.cn/wp-content/avatars/e1759c81c0cfe4ebc59fe13b5737f3bf.png"
                                 alt="@华子春xys">
                        </div>
                    

                    <div class="gt-comment-content">
                        <div class="gt-comment-header">
                            <div class="gt-comment-block-2"></div>
                            <a class="gt-comment-username">
                                华子春xys
                            </a>
                            
                                <span class="gt-comment-text">commented at</span>
                            
                            <span class="gt-comment-date">
                                2019-01-29
                            </span>
                        </div>
                        <div class="gt-comment-body markdown-body">
                            <p>
                                专业的帖子，虽然看不懂。也来支持一下。
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
</div>

</div>


            </main>
            
                <aside class="col-md-4 sidebar">
    
<div class="widget">
    <h3 class="title">
        关注我
    </h3>
    <div class="content follow_me">
        
        <a href="//github.com/geekeren" rel="external nofollow" title="github" target="_blank" class="github">
            <i class="github fa fa-github"></i>
        </a>
        
        <a href="mailto:me@mail.wangbaiyuan.cn" rel="external nofollow" title="email" target="_blank" class="email">
            <i class="envelope-o fa fa-envelope-o"></i>
        </a>
        
        <a href="//weibo.com/3734351975" rel="external nofollow" title="weibo" target="_blank" class="weibo">
            <i class="weibo fa fa-weibo"></i>
        </a>
        
        <a href="/atom.xml" rel="external nofollow" title="rss" target="_blank" class="rss">
            <i class="feed fa fa-feed"></i>
        </a>
        
    </div>
</div>


    
    <div class="widget">
        <h3 class="title">
            订阅微信公众号
        </h3>
        <div class="content subscribe_wechat">
            <div>
                <img
                        width="200"
                        src="/img/wechat.jpg" alt="扫一扫关注<br/>
《我是极客人》微信公众号
"
                />
            </div>
            <div>
                扫一扫关注<br/>
《我是极客人》微信公众号

            </div>
        </div>
    </div>


</aside>


<aside id="article-toc" role="navigation" class="col-md-4 sidebar scroll-fix">
    <div class="widget">
        <h3 class="title">
            文章目录
        </h3>
        
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-text">健康检查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%B1%E7%BB%AA%E6%8E%A2%E9%92%88"><span class="toc-text">就绪探针</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E6%B4%BB%E6%8E%A2%E9%92%88"><span class="toc-text">存活探针</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B"><span class="toc-text">工作过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%B1%E7%BB%AA%E6%8E%A2%E9%92%88-1"><span class="toc-text">就绪探针</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E6%B4%BB%E6%8E%A2%E9%92%88-1"><span class="toc-text">存活探针</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A2%E9%92%88%E7%B1%BB%E5%9E%8B"><span class="toc-text">探针类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E6%8E%A2%E6%B5%8B%E5%BB%B6%E8%BF%9F"><span class="toc-text">初始探测延迟</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BE%E4%BE%8B"><span class="toc-text">举例</span></a></li></ol>
        
    </div>
</aside>



            
        </div>
    </div>
</section>
<footer class="main-footer">
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <span>&copy;
                    2014 - 2024
                    <a href="https://baiyuan.wang" target="_blank">王柏元的博客</a>
                    <a href="//beian.miit.gov.cn/" target="_blank" rel="nofollow">
                        鄂ICP备2022019264号-1</a>
                    
                </span>|
                <span>
                   
    <script
            type="text/javascript"
            src="https://s4.cnzz.com/z_stat.php?id=1254162355&web_id=1254162355"
    >
    </script>





                </span>|
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span>|
                <span>
                    Theme by <a href="https://github.com/geekeren/hexo-theme-snippet-pro" class="copyright-links"
                                target="_blank" rel="nofollow">Snippet Pro</a>
                </span>
            </div>
        </div>
    </div>
</div>




<script src="/js/app.js?rev=@@hash.js"></script>


    

    <a id="back-to-top" class="icon-btn hide">
        <i class="fa fa-chevron-up"></i>
    </a>
</footer>

</body>
</html>
